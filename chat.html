<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>PAF X — Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0b0b0b;
  font-family:system-ui;
  color:#fff;
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* HEADER */
.top{
  height:56px;
  background:#141414;
  display:flex;
  align-items:center;
  padding:0 14px;
  border-bottom:1px solid #1f1f1f;
}
.back{font-size:22px;cursor:pointer;margin-right:10px}
.name{font-weight:600}

/* MESSAGES */
#messages{
  flex:1;
  padding:14px;
  overflow-y:auto;
}

.msg{
  max-width:75%;
  margin-bottom:10px;
  padding:10px 14px;
  border-radius:16px;
  font-size:14px;
}
.me{
  background:#e50914;
  margin-left:auto;
}
.other{
  background:#1f1f1f;
}

/* INPUT */
.input{
  display:flex;
  padding:10px;
  border-top:1px solid #1f1f1f;
}
.input input{
  flex:1;
  padding:12px;
  background:#141414;
  border:none;
  color:#fff;
  border-radius:20px;
}
.input button{
  margin-left:8px;
  padding:0 18px;
  border:none;
  background:#e50914;
  color:#fff;
  border-radius:20px;
}
</style>
</head>

<body>

<div class="top">
  <div class="back" onclick="history.back()">←</div>
  <div class="name" id="chatName">Discussion</div>
</div>

<div id="messages"></div>

<div class="input">
  <input id="text" placeholder="Message…">
  <button onclick="send()">➤</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { 
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCAsEnTrE0EvR0ZwbS_YpF3a4Ph3S3VHZQ",
  authDomain: "paf-x-56f2d.firebaseapp.com",
  projectId: "paf-x-56f2d",
  storageBucket: "paf-x-56f2d.firebasestorage.app",
  messagingSenderId: "1023059500240",
  appId: "1:1023059500240:web:9d3a646b52f510cbd512d5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* CHAT ID (temporaire pour test) */
const chatId = "general";

/* AUTH */
let currentUser=null;
onAuthStateChanged(auth,(u)=>{
  if(!u) location.href="index.html";
  currentUser=u;
  loadMessages();
});

/* LOAD MESSAGES */
function loadMessages(){
  const q = query(
    collection(db,"chats",chatId,"messages"),
    orderBy("createdAt")
  );

  onSnapshot(q,(snap)=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.sender===currentUser.email?"me":"other");
      div.textContent=m.text;
      messages.appendChild(div);
      messages.scrollTop=messages.scrollHeight;
    });
  });
}

/* SEND */
window.send=async()=>{
  if(!text.value.trim()) return;

  await addDoc(collection(db,"chats",chatId,"messages"),{
    text:text.value,
    sender:currentUser.email,
    createdAt:serverTimestamp()
  });
  text.value="";
};
</script>

</body>
</html>
